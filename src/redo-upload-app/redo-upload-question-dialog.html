<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="shared-styles.html">

<dom-module id="redo-upload-question-dialog">
	<template>
		<style include="shared-styles">
			:host(:not([opened])) .background{
				display: none;
			}
			:host([opened]) .background{
				display: flex;
				z-index: 200;
			}
			paper-dialog{
				width: 600px;
				padding: 20px;
				position: relative;
				text-align: center;
			}
			i.close {
			    position: absolute;
			    top: -3px;
			    right: -3px;
			    cursor: pointer;
			    font-size: 26px;
			    z-index: 40;
			}
			.background{
				position: fixed;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.2);
				align-items: center;
				justify-content: center;
				top: 0;
				left: 0;
			}
			.question{
				display: flex;
				justify-content: stretch;
				align-items: center;
			}
			.question .description{
				flex: 2;
			}
			.index{
				padding: 8px 10px;
				text-align: center;
				background: var(--redo-transparent-red-background-color);
				border-radius: 3px;
				margin-right: 5px;
			}
			paper-button{
				margin:10px auto;
			}
			label{
				float: left;
				margin: 5px;
			}
			h2 {
			    font-weight: normal;
			    font-size: 20px;
			    color: darkgray;
			    padding-top: 20px;
			}
			.bibliography{
				margin-top: 0px;
			}
			.radio-buttons{
				display: flex;
			    align-items: center;
			    justify-content: space-between;
			}
		</style>
		<div class="background">
			<paper-dialog opened="{{opened}}" id="dialog">
				<i class="material-icons close" on-click="_toggle">close
					<paper-ripple></paper-ripple>
				</i>
				<h2>[[title]]</h2>
				<div class="field">
					<label>Descripción:</label>
					<textarea id="description" rows="5" on-input="_descriptionChanged"></textarea>
				</div>
				<div class="question">
					<div class="index">A</div>
					<iron-input bind-value="{{question.answers.0.description}}"><input type="text"></iron-input>
				</div>
				<div class="question">
					<div class="index">B</div>
					<iron-input bind-value="{{question.answers.1.description}}"><input type="text"></iron-input>
				</div>
				<div class="question">
					<div class="index">C</div>
					<iron-input bind-value="{{question.answers.2.description}}"><input type="text"></iron-input>
				</div>
				<div class="question">
					<div class="index">D</div>
					<iron-input bind-value="{{question.answers.3.description}}"><input type="text"></iron-input>
				</div>
				<div class="field radio-buttons">
					<label>Elige la respuesta correcta:</label>
					<paper-radio-group selected="{{selectedAnswer}}">
						<paper-radio-button name="0">A</paper-radio-button>
						<paper-radio-button name="1">B</paper-radio-button>
						<paper-radio-button name="2">C</paper-radio-button>
						<paper-radio-button name="3">D</paper-radio-button>
					</paper-radio-group>
				</div>
				<div class="field bibliography">
					<label>Bibliografía (opcional):</label>
					<textarea id="bibliography" rows="5" on-input="_bibliographyChanged"></textarea>
				</div>
				<paper-button on-click="_saveQuestion" disabled="[[loading]]"><i class="material-icons">save</i>
					<template is="dom-if" if="[[!loading]]">Guardar</template>
					<template is="dom-if" if="[[loading]]">Guardando...</template>
				</paper-button>
			</paper-dialog>
			<paper-toast duration="6000" id="alert" text="Debes llenar todos los campos requeridos"></paper-toast>
			<paper-toast duration="6000" id="error" text="Error de conexión con el servidor"></paper-toast>
		</div>
		<iron-ajax
			id="saveAjax"
			method="POST"
			url="http://admin.redomedica.com/api/questions"
			content-type="application/json"
			body="[[question]]"
			loading="{{loading}}"
			on-response="_handleSaveResponse"
			on-error="_handleError"></iron-ajax>
		<iron-ajax
			id="updateAjax"
			method="PUT"
			content-type="application/json"
			body="[[question]]"
			loading="{{loading}}"
			on-response="_handleUpdateResponse"
			on-error="_handleError"></iron-ajax>
	</template>
	<script>
		class RedoUploadQuestionDialog extends Polymer.Element{
			static get is() { return 'redo-upload-question-dialog' }

			static get properties(){
				return{
					question:{
						type: Object,
						value:{
							description:"",
							bibliography:"",
							answers:[
								{description:""},
								{description:""},
								{description:""},
								{description:""},
							],
							category:{
								id: null
							},
							id:null
						}
					},
					selectedAnswer:String,
					opened:{
						type: Boolean,
						value: false,
						reflectToAttribute: true,
					},
					title:{
						type: String,
						value: "Nueva Pregunta"
					},
			        loading:{
			            type: Boolean,
			            value: false,
			        },
					categoryId:Number
				}
			}

			open(){
				this.opened = true
				this.title =  this.question.id ? "Editar Pregunta" : "Nueva Pregunta"
				this.question.category.id = this.categoryId
				this.$.bibliography.value = this.question.bibliography ? this.question.bibliography : ""
				this.$.description.value = this.question.description ? this.question.description : ""
				if(this.question.id) this.question.answers.forEach((it,index)=>{if(it.isCorrectAnswer) this.selectedAnswer = index})
			}

			_clear(){
				this.shadowRoot.querySelector("paper-dialog").querySelectorAll("textarea").forEach(it=>{it.value=""})
				this.selectedAnswer=""
				this.question = {
							description:"",
							bibliography:"",
							answers:[
								{description:""},
								{description:""},
								{description:""},
								{description:""},
							],
							category:{
								id: null
							},
							id:null
						}
			}

			_toggle(){
				this.opened = !this.opened
			}

			_handleSaveResponse(r){
				if (r.detail.response.success) {
					this.question.id = r.detail.response.data
					this.dispatchEvent( new CustomEvent('add', { bubbles: true, composed: true, detail: this.question }))
					this._toggle()

				}else{
					this._handleError(r)
				}
			}

			_handleUpdateResponse(r){
				if (r.detail.response.success) {
					this.dispatchEvent( new CustomEvent('edit', { bubbles: true, composed: true, detail: this.question }))
					this._toggle()
				}else{
					this._handleError(r)
				}
			}

			_handleError(e){
				this.$.error.toggle()
			}

			_descriptionChanged(e){
				this.set('question.description', e.target.value)
			}

			_bibliographyChanged(e){
				this.set('question.bibliography', e.target.value)
			}

			_saveQuestion(){
				console.log(this.question)
				if(this._isFormValid()){
					this.question.answers.forEach(it =>{ it.isCorrectAnswer = false })
					this.question.answers[this.selectedAnswer].isCorrectAnswer = true
					if(this.question.id){
						this.$.updateAjax.url = "http://admin.redomedica.com/api/questions/"+this.question.id
						this.$.updateAjax.generateRequest()
					}
					else this.$.saveAjax.generateRequest()
				}
				else this.$.alert.toggle()
			}

			_isFormValid(){
				return  this.question.description 
						&& this.selectedAnswer 
						&& !this.question.answers.find(it =>{ return !it.description })
			}


			_imageUpload(e){
				console.log(e)
			}

		}

		customElements.define(RedoUploadQuestionDialog.is, RedoUploadQuestionDialog)
	</script>
</dom-module>